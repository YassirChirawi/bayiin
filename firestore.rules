rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to get the signed-in user's data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Helper to check if the user belongs to the store they are trying to access
    function belongsToStore(storeId) {
       // Check if the storeId matches the one in their user profile
       return getUserData().storeId == storeId;
    }

    // Helper functions for Data Validation
    function isValidPhone(data) {
      // Check if phone exists and matches 10 digits
      return !("clientPhone" in data) || (data.clientPhone is string && data.clientPhone.matches('^\\d{10}$'));
    }
    
    function isValidPrice(data) {
       // Only validate if price is present (allow partial updates if field missing, or enforce schema?)
       // Simpler: if 'price' is in data, it must be number >= 0
       return !("price" in data) || (data.price is number && data.price >= 0);
    }

    // Users collection: Users can read/write their own profile
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Stores collection: 
    // CRITICAL SECURITY FIX: Only authenticated users can create. Only OWNERS/TEAM can read/update.
    match /stores/{storeId} {
      allow create: if request.auth != null;
      allow read, update: if request.auth != null && belongsToStore(storeId);
      
      // Allow reading stats subcollection
      match /stats/{statId} {
         allow read: if request.auth != null && belongsToStore(storeId);
      }
    }

    // Products
    match /products/{productId} {
       allow read: if request.auth != null && resource.data.storeId == getUserData().storeId;
       allow create: if request.auth != null && 
                     request.resource.data.storeId == getUserData().storeId &&
                     isValidPrice(request.resource.data);
       allow update: if request.auth != null && 
                     resource.data.storeId == getUserData().storeId &&
                     isValidPrice(request.resource.data);
       allow delete: if request.auth != null && resource.data.storeId == getUserData().storeId;
    }
    
    // Orders
    match /orders/{orderId} {
       allow read: if request.auth != null && resource.data.storeId == getUserData().storeId;
       allow create: if request.auth != null && 
                     request.resource.data.storeId == getUserData().storeId &&
                     isValidPhone(request.resource.data) &&
                     isValidPrice(request.resource.data);
       allow update: if request.auth != null && 
                     resource.data.storeId == getUserData().storeId &&
                     isValidPhone(request.resource.data) &&
                     isValidPrice(request.resource.data);
       allow delete: if request.auth != null && resource.data.storeId == getUserData().storeId;
    }

    // Expenses (Ads, Shipping, etc.) - Critical for Finances page
    match /expenses/{expenseId} {
       allow read: if request.auth != null && resource.data.storeId == getUserData().storeId;
       allow create: if request.auth != null && request.resource.data.storeId == getUserData().storeId;
       allow update, delete: if request.auth != null && resource.data.storeId == getUserData().storeId;
    }

    match /customers/{customerId} {
       allow read: if request.auth != null && resource.data.storeId == getUserData().storeId;
       allow create: if request.auth != null && request.resource.data.storeId == getUserData().storeId;
       allow update, delete: if request.auth != null && resource.data.storeId == getUserData().storeId;
    }

    // Team Management / Allowed Users
    match /allowed_users/{userId} {
       allow read: if request.auth != null && resource.data.email == request.auth.token.email;
       
       allow read: if request.auth != null && belongsToStore(resource.data.storeId);
       allow create: if request.auth != null && belongsToStore(request.resource.data.storeId);
       allow delete: if request.auth != null && belongsToStore(resource.data.storeId);
    }

    // Public Leads / Waiting List
    match /leads/{leadId} {
       allow create: if true; 
       allow read, update, delete: if false;
    }
  }
}
