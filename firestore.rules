rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPERS ---

    // Get the signed-in user's data (cached by Firestore rules for same request)
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if the user belongs to the store they are trying to access
    function belongsToStore(storeId) {
       // Ideally, we verify against the user document, but for read speed rules
       // often rely on custom claims. Here we stick to document lookup as users are < 100 per store.
       return getUserData().storeId == storeId;
    }

    // Type Checks
    function isNumber(num) {
      return num is number || num is float || num is int;
    }
    
    function isString(str) {
      return str is string;
    }

    // --- VALIDATORS ---

    // Validate Store Write
    function isValidStoreUpdate(data) {
       // Must prevent editing 'subscriptionStatus' directly unless via Admin SDK (backend)
       // But owner might need to update logo/address.
       // We restrict 'plan' and 'subscriptionStatus' updates.
       return !data.diff(resource.data).affectedKeys().hasAny(['plan', 'subscriptionStatus', 'stripeCustomerId']);
    }

    // Validate Product
    function isValidProduct(data) {
       return data.storeId == getUserData().storeId &&
              data.name is string && data.name.size() > 0 &&
              isNumber(data.price) && data.price >= 0 &&
              isNumber(data.stock) &&
              (!("costPrice" in data) || (isNumber(data.costPrice) && data.costPrice >= 0));
    }

    // Validate Order
    function isValidOrder(data) {
       return data.storeId == getUserData().storeId &&
              isNumber(data.price) && data.price >= 0 &&
              isNumber(data.quantity) && data.quantity > 0 &&
              ("status" in data == false || data.status in ['reçu', 'confirmation', 'packing', 'ramassage', 'livraison', 'reporté', 'livré', 'retour', 'annulé', 'pas de réponse']) &&
              (!("isPaid" in data) || data.isPaid is bool) &&
              (!("realDeliveryCost" in data) || (isNumber(data.realDeliveryCost) && data.realDeliveryCost >= 0));
    }

    // Check if user is Super Admin
    function isSuperAdmin() {
      return getUserData().role == 'super_admin';
    }

    // Check if the user owns the store
    function isStoreOwner(storeId) {
      return get(/databases/$(database)/documents/stores/$(storeId)).data.ownerId == request.auth.uid;
    }

    // --- RULES ---

    // Users collection
    match /users/{userId} {
      allow read: if request.auth != null && (request.auth.uid == userId || isSuperAdmin());
      allow create: if request.auth != null && request.auth.uid == userId; // Initial creation
      allow update: if request.auth != null && request.auth.uid == userId && 
                    !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']);
      allow write: if request.auth != null && isSuperAdmin(); // Super admin can do anything
    }

    // Stores collection
    match /stores/{storeId} {
      allow create: if request.auth != null;
      allow read: if true; // Public access for Catalog Branding
      allow update: if request.auth != null && (( (belongsToStore(storeId) || resource.data.ownerId == request.auth.uid) && isValidStoreUpdate(request.resource.data)) || isSuperAdmin());
      allow delete: if request.auth != null && isSuperAdmin();
      
      match /stats/{statId} {
         allow read, write: if request.auth != null && (isStoreOwner(storeId) || belongsToStore(storeId) || isSuperAdmin());
      }
      match /audit_logs/{logId} {
         allow read, create: if request.auth != null && (isStoreOwner(storeId) || belongsToStore(storeId) || isSuperAdmin());
      }
    }

    // Products
    match /products/{productId} {
       allow read: if true; // Public access for Catalog
       allow create: if request.auth != null && (isStoreOwner(request.resource.data.storeId) || request.resource.data.storeId == getUserData().storeId || isSuperAdmin());
       allow update, delete: if request.auth != null && (isStoreOwner(resource.data.storeId) || resource.data.storeId == getUserData().storeId || isSuperAdmin());
    }
    
    // Orders
    match /orders/{orderId} {
       allow read: if request.auth != null && (isStoreOwner(resource.data.storeId) || resource.data.storeId == getUserData().storeId || isSuperAdmin());
       allow create: if (request.auth != null && (isStoreOwner(request.resource.data.storeId) || request.resource.data.storeId == getUserData().storeId || isSuperAdmin()))
                        || (request.resource.data.status == 'pending_catalog');
       allow update, delete: if request.auth != null && (isStoreOwner(resource.data.storeId) || resource.data.storeId == getUserData().storeId || isSuperAdmin());
    }

    // Expenses
    match /expenses/{expenseId} {
       allow read, write: if request.auth != null && (isStoreOwner(resource.data.storeId) || resource.data.storeId == getUserData().storeId || isSuperAdmin());
       allow create: if request.auth != null && (isStoreOwner(request.resource.data.storeId) || request.resource.data.storeId == getUserData().storeId || isSuperAdmin());
    }

    // Customers
    match /customers/{customerId} {
       allow read, write: if request.auth != null && (isStoreOwner(resource.data.storeId) || resource.data.storeId == getUserData().storeId || isSuperAdmin());
       allow create: if request.auth != null && (isStoreOwner(request.resource.data.storeId) || request.resource.data.storeId == getUserData().storeId || isSuperAdmin());
    }

    // Team Management
    match /allowed_users/{userId} {
       allow read: if request.auth != null && (resource.data.email == request.auth.token.email || belongsToStore(resource.data.storeId) || isStoreOwner(resource.data.storeId) || isSuperAdmin());
       allow create: if request.auth != null && (belongsToStore(request.resource.data.storeId) || isStoreOwner(request.resource.data.storeId) || isSuperAdmin());
       allow update, delete: if request.auth != null && (belongsToStore(resource.data.storeId) || isStoreOwner(resource.data.storeId) || isSuperAdmin());
    }

    // Public Leads
    match /leads/{leadId} {
       allow create: if true;
       allow read: if request.auth != null && (belongsToStore(resource.data.storeId) || isStoreOwner(resource.data.storeId) || isSuperAdmin());
    }
    // Custom Events (Planning)
    match /events/{eventId} {
       allow read, write: if request.auth != null && (isStoreOwner(resource.data.storeId) || resource.data.storeId == getUserData().storeId || isSuperAdmin());
       allow create: if request.auth != null && (isStoreOwner(request.resource.data.storeId) || request.resource.data.storeId == getUserData().storeId || isSuperAdmin());
    }

    // System Announcements
    match /system/announcements {
        allow read: if true;
        allow write: if request.auth != null && isSuperAdmin();
    }
  }
}
